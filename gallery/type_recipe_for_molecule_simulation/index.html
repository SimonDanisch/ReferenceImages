<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JuliaDocs/Documenter.jl/assets/html/documenter.css">
  </head>
  <body>
    <div><h2>Type recipe for molecule simulation</h2><pre><code class="language-julia">using Makie
 import AbstractPlotting: Plot, default_theme, plot!, to_value
 using Makie


 struct Simulation
     grid::Vector{Point3f0}
 end
 # Probably worth having a macro for this!
 function default_theme(scene::SceneLike, ::Type{&lt;: Plot(Simulation)})
     Theme(
         advance = 0,
         molecule_sizes = [0.08, 0.04, 0.04],
         molecule_colors = [:maroon, :deepskyblue2, :deepskyblue2]
     )
 end

 # The recipe! - will get called for plot(!)(x::SimulationResult)
 function AbstractPlotting.plot!(p::Plot(Simulation))
     sim = to_value(p[1]) # first argument is the SimulationResult
     # when advance changes, get new positions from the simulation
     mpos = lift(p[:advance]) do i
         sim.grid .+ rand(Point3f0, length(sim.grid)) .* 0.01f0
     end
     # size shouldn&#39;t change, so we might as well get the value instead of signal
     pos = to_value(mpos)
     N = length(pos)
     sizes = lift(p[:molecule_sizes]) do s
         repeat(s, outer = N รท 3)
     end
     sizes = lift(p[:molecule_sizes]) do s
         repeat(s, outer = N รท 3)
     end
     colors = lift(p[:molecule_colors]) do c
         repeat(c, outer = N รท 3)
     end
     scene = meshscatter!(p, mpos, markersize = sizes, color = colors)
     indices = Int[]
     for i in 1:3:N
         push!(indices, i, i + 1, i, i + 2)
     end
     meshplot = p.plots[end] # meshplot is the last plot we added to p
     # meshplot[1] -&gt; the positions (first argument) converted to points, so
     # we don&#39;t do the conversion 2 times for linesegments!
     linesegments!(p, lift(x-&gt; view(x, indices), meshplot[1]))
 end

 # To write out a video of the whole simulation
 n = 5
 r = range(-1, stop = 1, length = n)
 grid = Point3f0.(r, reshape(r, (1, n, 1)), reshape(r, (1, 1, n)))
 molecules = map(1:(n^3) * 3) do i
     i3 = ((i - 1) รท 3) + 1
     xy = 0.1; z = 0.08
     i % 3 == 1 &amp;&amp; return grid[i3]
     i % 3 == 2 &amp;&amp; return grid[i3] + Point3f0(xy, xy, z)
     i % 3 == 0 &amp;&amp; return grid[i3] + Point3f0(-xy, xy, z)
 end
 result = Simulation(molecules)
 scene = plot(result)
 N = 100
 record(scene, &quot;output.mp4&quot;, 1:N) do i
     scene[end][:advance] = i
end

</code></pre>
<div style="display:inline-block">
    <p style="display:inline-block; text-align: center">
        <video controls autoplay loop muted>
  <source src="/home/sd/.julia/dev/MakieGallery/test/test_recordings/type_recipe_for_molecule_simulation/media/type_recipe_for_molecule_simulation.mp4" type="video/mp4">
  Your browser does not support mp4. Please use a modern browser like Chrome or Firefox.
</video>

    </p>
</div>
</div>
  </body>
</html>

